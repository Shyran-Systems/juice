#!/usr/bin/env flusspferd
// -*- mode:javascript; -*- vim:filetype=javascript:enc=utf-8:

var args = require('system').args,
    zest = require('zest'),
    app,
    baseModules = {};

if (args[1] != '--no-reload') {
  print("Running skeleton in reloader mode...");

  // Flusspferd specific
  for (i in require.module_cache)
    baseModules[i] = true;

  app = function(request) {
    // Flusspferd specific - unload modules on request
    // But only those modules loaded after the initial startup
    for (i in require.module_cache) {
      if (i in baseModules == false) {
        delete require.module_cache[i];
      }
    }
    gc();

    return require('../lib/app').app(request);
  }
}
else {
  print("Running skeleton normal mode...");
  app = require( '../lib/app' ).app
}

// TODO: Do we want to call setup once here?

var server = zest.Zest( {
  handler: app
} );

server.start();

